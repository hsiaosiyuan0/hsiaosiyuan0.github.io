<!DOCTYPE html>
<html lang="en-us">
  <head>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>为什么需要检查 UTF-8 编码 | hsiaosiyuan</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="http://hsiaosiyuan0.github.io/css/theme-override.css">
    <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="http://hsiaosiyuan0.github.io/">~/hsiaosiyuan</a>
      </li>
      

      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">为什么需要检查 UTF-8 编码</span></h1>

<h2 class="date">2019/03/07</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>


<div class="content-wrapper">
  <main>
    <h2 id="为什么需要检查-utf-8-编码">为什么需要检查 UTF-8 编码</h2>
<p>根据 WebSocket 协议的要求 <a href="https://juejin.im/post/5c3ff7b5518825254c31a9a3#heading-9">5.6 数据帧</a>，如果 Frame 的 Opcode 是 <code>0x1</code> 的话，则表示这是一个文本帧，即其 “Application Data” 是使用 UTF-8 编码的字符串。不过由于消息也可以使用多个 Frame 进行分片传输，所以在验证文本消息的编码时，需要收集到消息的所有 Frames 后，提取所有的 Frame 中的 “Application Data” 组成一个大的  “Application Data”，然后验证这个大的  “Application Data” 中的字节是不是合法的 UTF-8 编码。</p>
<p>既然协议中要求了文本消息必须使用 UTF-8 编码，那么反过来，验证编码是否是 UTF-8就可以一定程度上确定消息的完整性。</p>
<h2 id="unicodehttpszhwikipediaorgwikiunicode"><a href="https://zh.wikipedia.org/wiki/Unicode">Unicode</a></h2>
<p>简单的说 Unicode 就是一种字符的编码方式，此编码方式一般使用两个字节（<a href="https://en.wikipedia.org/wiki/Universal_Coded_Character_Set">UCS-2</a>）去表示一个字符，比如“汉”这个中文字符，其 unicode 编码的十六进制表示就是 <code>0x6c49</code>。</p>
<h2 id="utf-8httpszhwikipediaorgwikiutf-8"><a href="https://zh.wikipedia.org/wiki/UTF-8">UTF-8</a></h2>
<p>UTF-8 的全称是 <strong>8-bit Unicode Transformation Format</strong> 中文就是 “8 位的 unicode 转换格式”。UTF-8 是具体的 Unicode 实现方式中的一种，套用 wiki 上的一段话：</p>
<blockquote>
<p>但是在实际传输过程中，由于不同<a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E5%B9%B3%E5%8F%B0">系统平台</a>的设计不一定一致，以及出于节省空间的目的，对Unicode编码的实现方式有所不同。Unicode的实现方式称为<strong>Unicode转换格式</strong>（Unicode Transformation Format，简称为UTF）</p>
</blockquote>
<h2 id="utf-8-的编码方式">UTF-8 的编码方式</h2>
<blockquote>
<p>UTF-8使用一至六个字节为每个字符编码（尽管如此，2003年11月UTF-8被<a href="https://tools.ietf.org/html/rfc3629">RFC 3629</a>重新规范，只能使用原来Unicode定义的区域，U+0000到U+10FFFF，也就是说最多四个字节）</p>
</blockquote>
<pre><code>   Char. number range  |        UTF-8 octet sequence
      (hexadecimal)    |              (binary)
   --------------------+---------------------------------------------
   0000 0000-0000 007F | 0xxxxxxx
   0000 0080-0000 07FF | 110xxxxx 10xxxxxx
   0000 0800-0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx
   0001 0000-0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
</code></pre><ul>
<li>对于 UTF-8 编码中的任意字节B，如果B的第一位为0，则B为ASCII码，并且B独立的表示一个字符；</li>
<li>如果B的第一位为1，第二位为0，则B为一个非ASCII字符（该字符由多个字节表示）中的一个字节，并且不是字符的第一个字节编码；</li>
<li>如果B的前两位为1，第三位为0，则B为一个非ASCII字符（该字符由多个字节表示）中的第一个字节，并且该字符由两个字节表示；</li>
<li>如果B的前三位为1，第四位为0，则B为一个非ASCII字符（该字符由多个字节表示）中的第一个字节，并且该字符由三个字节表示；</li>
<li>如果B的前四位为1，第五位为0，则B为一个非ASCII字符（该字符由多个字节表示）中的第一个字节，并且该字符由四个字节表示；</li>
</ul>
<p>所以我们只需要兼容最新的标准即可。如果你还没有明白 UTF-8 编码的含义，我们可以看一个具体的例子，比如中文的 “汉”，其 Unicode 编码的十六进制表示是 <code>0x6c49</code>，那么很明显，它必然落在 <code>0x00000800 – 0x0000FFFF</code> 这个区间内，而这个区间的字符必须使用 3 个字节的 UTF-8 编码，表示成 <code>1110xxxx 10xxxxxx 10xxxxxx</code> 的形式。</p>
<p>所以对于 <code>0x6c49</code> 要转成 UTF-8 编码：</p>
<ol>
<li>将 <code>0x6c49</code> 右移 12 位，取出最高的 4 位，然后或上 <code>11100000</code>（即 <code>0xE0</code>），得到第一个字节 <code>0xE6</code></li>
<li>将 <code>0x6c49</code> 与上 <code>0000111111000000</code>（即 <code>0xFC0</code>） 后、右移 6 位，这样得到中间的 6 位，然后或上 <code>10000000</code>（即 <code>0x80</code>） 得到第二个字节 <code>0xB1</code></li>
<li>将 <code>0x6c49</code> 与上 <code>0000000000111111</code>（即 <code>0x3F</code>） 后，或上 <code>10000000</code>（即 <code>0x80</code>） 得到第三个字节 <code>0x89</code></li>
</ol>
<p>于是中文字符 “汉” 的 UTF-8 编码就是 <code>0xE6 0xB1 0x89</code>，是不是 so easy。</p>
<p>现在，假设现在我们得到一串数据，它包含 3 个字节，其内容是 <code>0xE6 0xB1 0x89</code>，并且我们知道这串数据采用的是 UTF-8 编码，我们怎么得知其对应的 unicode 编码是什么呢？一种一种的情况试啊！</p>
<ol>
<li>取出第一个字节，检查其最高位是不是 0，如果是0，那么当前字节即表示一个字符，如果不是，进行下一步</li>
<li>检查最高 3 位是不是 <code>110</code>，如果是的话，那么接下来的一个字节和当前字节合起来表示一个字符，如果不是，进行下一步</li>
<li>检查最高 4 位是不是 <code>1110</code>，如果是的话，那么接下来的两个字节和当前字节合起来表示一个字符，如果不是，进行下一步</li>
<li>检查最高 5 位是不是 <code>11110</code>，如果是的话，那么接下来的三个字节和当前字节合起来表示一个字符，如果不是，进行下一步</li>
<li>根据最新的标准，UTF-8 编码最多只使用四个字节去表示一个字符，所以到了这一步就说明编码错误了</li>
<li>另外除了表示剩余字节数的那个字节外，其余字节的最高两位都必须是 <code>10</code></li>
<li><code>U+0000</code> 不可以使用两个字节进行编码</li>
<li><code>U+D800~U+DFFF</code> （左右边界不可取）是保留段，不可以使用</li>
</ol>
<p>那么看看刚才的例子，我们取出第一个字节 <code>0xE6</code>（即 <code>1110 0110</code>），我要逐一的尝试每一种情况，最后我们发现它的最高 4 位是 <code>1110</code> 那么它之后的两个字节和它一起表示一个字符。</p>
<ol>
<li>首先我们先将第一个字节与上 <code>0xF</code>，这样可以得到实际的 4 位</li>
<li>取出紧随的第二个字节，将其与上 <code>0x3F</code>，这样可以得到实际的 6 位</li>
<li>取出紧随的第三个字节，将其与上 <code>0x3F</code>，这样可以得到实际的 6 位</li>
</ol>
<p>最后将这 16 个数位按照取出的顺序从左往右放存放到三个字节中。</p>
<h2 id="代码">代码</h2>
<p>先放 javascript 的，注意这里使用了 ES6 中的 <code>String.prototype.codePointAt</code> 方法，因为在 ES5 中对于超过了 <code>0xFFFF</code> 的字符使用 <code>String.prototype.charCodeAt</code> 并不能正确的获取其 unicode 编码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#e6db74">&#34;use strict&#34;</span>;

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#66d9ef">typeof</span> String.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">codePointAt</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span>, <span style="color:#e6db74">&#34;Current env doesn&#39;t support ECMAScript 6!&#34;</span>);

Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">equal</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">b</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">every</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">i</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">b</span>[<span style="color:#a6e22e">i</span>];
    });
};

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">unicode2utf8</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">unicode</span>) {
    <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;string&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">unicode</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">:</span> <span style="color:#a6e22e">unicode</span>;

    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span>) {
        <span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">unicode</span>]
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7FF</span>) {
        <span style="color:#66d9ef">return</span> [
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xC0</span>,
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>
        ];
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFF</span>) {
        <span style="color:#66d9ef">return</span> [
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xE0</span>,
            (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFC0</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>,
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>
        ];
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x10000</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x10FFFF</span>) {
        <span style="color:#66d9ef">return</span> [
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xF0</span>,
            (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F000</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>,
            (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFC0</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>,
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>
        ];
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;deformed unicode: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">unicode</span>);
    }
};

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;u&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0x75</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;u&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;©&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;©&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;汉&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;汉&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;😄&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;😄&#39;&#34;</span>);

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">utf82unicode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">utf8</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">utf8</span>.<span style="color:#a6e22e">length</span>, <span style="color:#66d9ef">byte</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">0</span>];

    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;empty utf8&#39;</span>);
    }

    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">127</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">byte</span>;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
        <span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span>
                <span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
        <span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">|</span>
                ((<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span>
                (<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>)
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1E</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>) {
        <span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">18</span>) <span style="color:#f92672">|</span>
                ((<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">|</span>
                ((<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span>
                (<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>)
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;deformed utf8: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">utf8</span>);
    }
};

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0x75</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;u&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;u&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;©&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;©&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;汉&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;汉&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;😄&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;😄&#39;&#34;</span>);
</code></pre></div><p>接下来是 golang 的，其中的 <code>IsIntactUtf8</code> 函数就是本文讨论的主题 - 检查UTF-8编码的完整性：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uint32</span>) (<span style="color:#a6e22e">u8</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">u</span>)}, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7FF</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span> | <span style="color:#ae81ff">0xC0</span>),
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> | <span style="color:#ae81ff">0x80</span>),
		}, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFF</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">12</span> | <span style="color:#ae81ff">0xE0</span>),
			byte((<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFC0</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span> | <span style="color:#ae81ff">0x80</span>),
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> | <span style="color:#ae81ff">0x80</span>),
		}, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x10000</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x10FFFF</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">18</span> | <span style="color:#ae81ff">0xF0</span>),
			byte((<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F000</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">12</span> | <span style="color:#ae81ff">0x80</span>),
			byte((<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFC0</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span> | <span style="color:#ae81ff">0x80</span>),
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> | <span style="color:#ae81ff">0x80</span>),
		}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;deformed unicode: %d&#34;</span>, <span style="color:#a6e22e">u</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestUnicode2utf8</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0x75</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x75</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;u&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0xA9</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;©&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0x6C49</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;汉&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0x1F604</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;😄&#39;&#34;</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Utf82unicode</span>(<span style="color:#a6e22e">u8</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">u8l</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">u8</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;empty utf8&#34;</span>)
	}

	<span style="color:#a6e22e">b1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">0</span>]
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span>), <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x1F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>), <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xF</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>), <span style="color:#66d9ef">nil</span>

	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1E</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x7</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">18</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>), <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;deformed utf8: %d&#34;</span>, <span style="color:#a6e22e">u8</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestUtf82unicode</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x75</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x75</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;u&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xA9</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;©&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x6C49</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;not pass &#39;汉&#39;: %x&#34;</span>, <span style="color:#a6e22e">u</span>)
	}

	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x1F604</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;😄&#39;&#34;</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsIntactUtf8</span>(<span style="color:#a6e22e">u8</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#a6e22e">u8l</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">u8</span>)

	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">u8l</span> {
			<span style="color:#66d9ef">break</span>
		}

		<span style="color:#a6e22e">b1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span>]
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tu</span> <span style="color:#66d9ef">uint32</span>

		<span style="color:#66d9ef">switch</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span>:
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#75715e">// U+0000 encoded in two bytes: incorrect
</span><span style="color:#75715e"></span>				(<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span>] &gt; <span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] &gt; <span style="color:#ae81ff">0x80</span>) {
				<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span> {
				<span style="color:#a6e22e">tu</span> = uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xF</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span> |
					uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
					uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)

				<span style="color:#75715e">// UTF-8 prohibits encoding character numbers between U+D800 and U+DFFF
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tu</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">tu</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#f92672">&amp;&amp;</span> !(<span style="color:#a6e22e">tu</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0xD800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">tu</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xDFFF</span>) {
					<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
				}
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1E</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x7</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x4</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xF</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> {
				<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
		<span style="color:#66d9ef">default</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
		}
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">u8l</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ValidTest</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">in</span>  <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">out</span> <span style="color:#66d9ef">bool</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">validTests</span> = []<span style="color:#a6e22e">ValidTest</span>{
	{<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;abc&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;Ж&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;ЖЖ&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;брэд-ЛГТМ&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;☺☻☹&#34;</span>, <span style="color:#66d9ef">true</span>},
	{string([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">250</span>}), <span style="color:#66d9ef">false</span>},
	{string([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">67</span>}), <span style="color:#66d9ef">false</span>},
	{<span style="color:#e6db74">&#34;a\uFFFDb&#34;</span>, <span style="color:#66d9ef">true</span>},
	{string(<span style="color:#e6db74">&#34;\xF4\x8F\xBF\xBF&#34;</span>), <span style="color:#66d9ef">true</span>},      <span style="color:#75715e">// U+10FFFF
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xF4\x90\x80\x80&#34;</span>), <span style="color:#66d9ef">false</span>},     <span style="color:#75715e">// U+10FFFF+1; out of range
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xF7\xBF\xBF\xBF&#34;</span>), <span style="color:#66d9ef">false</span>},     <span style="color:#75715e">// 0x1FFFFF; out of range
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xFB\xBF\xBF\xBF\xBF&#34;</span>), <span style="color:#66d9ef">false</span>}, <span style="color:#75715e">// 0x3FFFFFF; out of range
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xc0\x80&#34;</span>), <span style="color:#66d9ef">false</span>},             <span style="color:#75715e">// U+0000 encoded in two bytes: incorrect
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xed\xa0\x80&#34;</span>), <span style="color:#66d9ef">false</span>},         <span style="color:#75715e">// U+D800 high surrogate (sic)
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xed\xbf\xbf&#34;</span>), <span style="color:#66d9ef">false</span>},         <span style="color:#75715e">// U+DFFF low surrogate (sic)
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestIsIntactUtf8</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">tt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">validTests</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">IsIntactUtf8</span>([]byte(<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">in</span>)) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">out</span> {
			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;[CASE %d] IsIntactUtf8(%q) = %v; want %v&#34;</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">in</span>, !<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">out</span>)
		}
	}
}
</code></pre></div><p>原理以及代码都给出来了，应该会对 UTF-8 以及 UTF-8 与 Unicode 之间的关系不明了的同学有些帮助吧。</p>

    <a href="/"> >> Home</a>
  </main>
</div>
    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/hsiaosiyuan0">GitHub</a>
      
    </footer>
  </body>
</html>

