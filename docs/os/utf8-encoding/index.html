<!DOCTYPE html>
<html lang="en-us">
  <head>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ UTF-8 ç¼–ç  | hsiaosiyuan</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="http://hsiaosiyuan0.github.io/css/theme-override.css">
    <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="http://hsiaosiyuan0.github.io/">~/hsiaosiyuan</a>
      </li>
      

      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ UTF-8 ç¼–ç </span></h1>

<h2 class="date">2019/03/07</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>


<div class="content-wrapper">
  <main>
    <h2 id="ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥-utf-8-ç¼–ç ">ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ UTF-8 ç¼–ç </h2>
<p>æ ¹æ® WebSocket åè®®çš„è¦æ±‚ <a href="https://juejin.im/post/5c3ff7b5518825254c31a9a3#heading-9">5.6 æ•°æ®å¸§</a>ï¼Œå¦‚æœ Frame çš„ Opcode æ˜¯ <code>0x1</code> çš„è¯ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å¸§ï¼Œå³å…¶ â€œApplication Dataâ€ æ˜¯ä½¿ç”¨ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚ä¸è¿‡ç”±äºæ¶ˆæ¯ä¹Ÿå¯ä»¥ä½¿ç”¨å¤šä¸ª Frame è¿›è¡Œåˆ†ç‰‡ä¼ è¾“ï¼Œæ‰€ä»¥åœ¨éªŒè¯æ–‡æœ¬æ¶ˆæ¯çš„ç¼–ç æ—¶ï¼Œéœ€è¦æ”¶é›†åˆ°æ¶ˆæ¯çš„æ‰€æœ‰ Frames åï¼Œæå–æ‰€æœ‰çš„ Frame ä¸­çš„ â€œApplication Dataâ€ ç»„æˆä¸€ä¸ªå¤§çš„  â€œApplication Dataâ€ï¼Œç„¶åéªŒè¯è¿™ä¸ªå¤§çš„  â€œApplication Dataâ€ ä¸­çš„å­—èŠ‚æ˜¯ä¸æ˜¯åˆæ³•çš„ UTF-8 ç¼–ç ã€‚</p>
<p>æ—¢ç„¶åè®®ä¸­è¦æ±‚äº†æ–‡æœ¬æ¶ˆæ¯å¿…é¡»ä½¿ç”¨ UTF-8 ç¼–ç ï¼Œé‚£ä¹ˆåè¿‡æ¥ï¼ŒéªŒè¯ç¼–ç æ˜¯å¦æ˜¯ UTF-8å°±å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¡®å®šæ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚</p>
<h2 id="unicodehttpszhwikipediaorgwikiunicode"><a href="https://zh.wikipedia.org/wiki/Unicode">Unicode</a></h2>
<p>ç®€å•çš„è¯´ Unicode å°±æ˜¯ä¸€ç§å­—ç¬¦çš„ç¼–ç æ–¹å¼ï¼Œæ­¤ç¼–ç æ–¹å¼ä¸€èˆ¬ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼ˆ<a href="https://en.wikipedia.org/wiki/Universal_Coded_Character_Set">UCS-2</a>ï¼‰å»è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œæ¯”å¦‚â€œæ±‰â€è¿™ä¸ªä¸­æ–‡å­—ç¬¦ï¼Œå…¶ unicode ç¼–ç çš„åå…­è¿›åˆ¶è¡¨ç¤ºå°±æ˜¯ <code>0x6c49</code>ã€‚</p>
<h2 id="utf-8httpszhwikipediaorgwikiutf-8"><a href="https://zh.wikipedia.org/wiki/UTF-8">UTF-8</a></h2>
<p>UTF-8 çš„å…¨ç§°æ˜¯ <strong>8-bit Unicode Transformation Format</strong> ä¸­æ–‡å°±æ˜¯ â€œ8 ä½çš„ unicode è½¬æ¢æ ¼å¼â€ã€‚UTF-8 æ˜¯å…·ä½“çš„ Unicode å®ç°æ–¹å¼ä¸­çš„ä¸€ç§ï¼Œå¥—ç”¨ wiki ä¸Šçš„ä¸€æ®µè¯ï¼š</p>
<blockquote>
<p>ä½†æ˜¯åœ¨å®é™…ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œç”±äºä¸åŒ<a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E5%B9%B3%E5%8F%B0">ç³»ç»Ÿå¹³å°</a>çš„è®¾è®¡ä¸ä¸€å®šä¸€è‡´ï¼Œä»¥åŠå‡ºäºèŠ‚çœç©ºé—´çš„ç›®çš„ï¼Œå¯¹Unicodeç¼–ç çš„å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒã€‚Unicodeçš„å®ç°æ–¹å¼ç§°ä¸º<strong>Unicodeè½¬æ¢æ ¼å¼</strong>ï¼ˆUnicode Transformation Formatï¼Œç®€ç§°ä¸ºUTFï¼‰</p>
</blockquote>
<h2 id="utf-8-çš„ç¼–ç æ–¹å¼">UTF-8 çš„ç¼–ç æ–¹å¼</h2>
<blockquote>
<p>UTF-8ä½¿ç”¨ä¸€è‡³å…­ä¸ªå­—èŠ‚ä¸ºæ¯ä¸ªå­—ç¬¦ç¼–ç ï¼ˆå°½ç®¡å¦‚æ­¤ï¼Œ2003å¹´11æœˆUTF-8è¢«<a href="https://tools.ietf.org/html/rfc3629">RFC 3629</a>é‡æ–°è§„èŒƒï¼Œåªèƒ½ä½¿ç”¨åŸæ¥Unicodeå®šä¹‰çš„åŒºåŸŸï¼ŒU+0000åˆ°U+10FFFFï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤šå››ä¸ªå­—èŠ‚ï¼‰</p>
</blockquote>
<pre><code>   Char. number range  |        UTF-8 octet sequence
      (hexadecimal)    |              (binary)
   --------------------+---------------------------------------------
   0000 0000-0000 007F | 0xxxxxxx
   0000 0080-0000 07FF | 110xxxxx 10xxxxxx
   0000 0800-0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx
   0001 0000-0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
</code></pre><ul>
<li>å¯¹äº UTF-8 ç¼–ç ä¸­çš„ä»»æ„å­—èŠ‚Bï¼Œå¦‚æœBçš„ç¬¬ä¸€ä½ä¸º0ï¼Œåˆ™Bä¸ºASCIIç ï¼Œå¹¶ä¸”Bç‹¬ç«‹çš„è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼›</li>
<li>å¦‚æœBçš„ç¬¬ä¸€ä½ä¸º1ï¼Œç¬¬äºŒä½ä¸º0ï¼Œåˆ™Bä¸ºä¸€ä¸ªéASCIIå­—ç¬¦ï¼ˆè¯¥å­—ç¬¦ç”±å¤šä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ä¸æ˜¯å­—ç¬¦çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç¼–ç ï¼›</li>
<li>å¦‚æœBçš„å‰ä¸¤ä½ä¸º1ï¼Œç¬¬ä¸‰ä½ä¸º0ï¼Œåˆ™Bä¸ºä¸€ä¸ªéASCIIå­—ç¬¦ï¼ˆè¯¥å­—ç¬¦ç”±å¤šä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¯¥å­—ç¬¦ç”±ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›</li>
<li>å¦‚æœBçš„å‰ä¸‰ä½ä¸º1ï¼Œç¬¬å››ä½ä¸º0ï¼Œåˆ™Bä¸ºä¸€ä¸ªéASCIIå­—ç¬¦ï¼ˆè¯¥å­—ç¬¦ç”±å¤šä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¯¥å­—ç¬¦ç”±ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›</li>
<li>å¦‚æœBçš„å‰å››ä½ä¸º1ï¼Œç¬¬äº”ä½ä¸º0ï¼Œåˆ™Bä¸ºä¸€ä¸ªéASCIIå­—ç¬¦ï¼ˆè¯¥å­—ç¬¦ç”±å¤šä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¯¥å­—ç¬¦ç”±å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›</li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å…¼å®¹æœ€æ–°çš„æ ‡å‡†å³å¯ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰æ˜ç™½ UTF-8 ç¼–ç çš„å«ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸­æ–‡çš„ â€œæ±‰â€ï¼Œå…¶ Unicode ç¼–ç çš„åå…­è¿›åˆ¶è¡¨ç¤ºæ˜¯ <code>0x6c49</code>ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œå®ƒå¿…ç„¶è½åœ¨ <code>0x00000800 â€“ 0x0000FFFF</code> è¿™ä¸ªåŒºé—´å†…ï¼Œè€Œè¿™ä¸ªåŒºé—´çš„å­—ç¬¦å¿…é¡»ä½¿ç”¨ 3 ä¸ªå­—èŠ‚çš„ UTF-8 ç¼–ç ï¼Œè¡¨ç¤ºæˆ <code>1110xxxx 10xxxxxx 10xxxxxx</code> çš„å½¢å¼ã€‚</p>
<p>æ‰€ä»¥å¯¹äº <code>0x6c49</code> è¦è½¬æˆ UTF-8 ç¼–ç ï¼š</p>
<ol>
<li>å°† <code>0x6c49</code> å³ç§» 12 ä½ï¼Œå–å‡ºæœ€é«˜çš„ 4 ä½ï¼Œç„¶åæˆ–ä¸Š <code>11100000</code>ï¼ˆå³ <code>0xE0</code>ï¼‰ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚ <code>0xE6</code></li>
<li>å°† <code>0x6c49</code> ä¸ä¸Š <code>0000111111000000</code>ï¼ˆå³ <code>0xFC0</code>ï¼‰ åã€å³ç§» 6 ä½ï¼Œè¿™æ ·å¾—åˆ°ä¸­é—´çš„ 6 ä½ï¼Œç„¶åæˆ–ä¸Š <code>10000000</code>ï¼ˆå³ <code>0x80</code>ï¼‰ å¾—åˆ°ç¬¬äºŒä¸ªå­—èŠ‚ <code>0xB1</code></li>
<li>å°† <code>0x6c49</code> ä¸ä¸Š <code>0000000000111111</code>ï¼ˆå³ <code>0x3F</code>ï¼‰ åï¼Œæˆ–ä¸Š <code>10000000</code>ï¼ˆå³ <code>0x80</code>ï¼‰ å¾—åˆ°ç¬¬ä¸‰ä¸ªå­—èŠ‚ <code>0x89</code></li>
</ol>
<p>äºæ˜¯ä¸­æ–‡å­—ç¬¦ â€œæ±‰â€ çš„ UTF-8 ç¼–ç å°±æ˜¯ <code>0xE6 0xB1 0x89</code>ï¼Œæ˜¯ä¸æ˜¯ so easyã€‚</p>
<p>ç°åœ¨ï¼Œå‡è®¾ç°åœ¨æˆ‘ä»¬å¾—åˆ°ä¸€ä¸²æ•°æ®ï¼Œå®ƒåŒ…å« 3 ä¸ªå­—èŠ‚ï¼Œå…¶å†…å®¹æ˜¯ <code>0xE6 0xB1 0x89</code>ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“è¿™ä¸²æ•°æ®é‡‡ç”¨çš„æ˜¯ UTF-8 ç¼–ç ï¼Œæˆ‘ä»¬æ€ä¹ˆå¾—çŸ¥å…¶å¯¹åº”çš„ unicode ç¼–ç æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸€ç§ä¸€ç§çš„æƒ…å†µè¯•å•Šï¼</p>
<ol>
<li>å–å‡ºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œæ£€æŸ¥å…¶æœ€é«˜ä½æ˜¯ä¸æ˜¯ 0ï¼Œå¦‚æœæ˜¯0ï¼Œé‚£ä¹ˆå½“å‰å­—èŠ‚å³è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥</li>
<li>æ£€æŸ¥æœ€é«˜ 3 ä½æ˜¯ä¸æ˜¯ <code>110</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„ä¸€ä¸ªå­—èŠ‚å’Œå½“å‰å­—èŠ‚åˆèµ·æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥</li>
<li>æ£€æŸ¥æœ€é«˜ 4 ä½æ˜¯ä¸æ˜¯ <code>1110</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„ä¸¤ä¸ªå­—èŠ‚å’Œå½“å‰å­—èŠ‚åˆèµ·æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥</li>
<li>æ£€æŸ¥æœ€é«˜ 5 ä½æ˜¯ä¸æ˜¯ <code>11110</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„ä¸‰ä¸ªå­—èŠ‚å’Œå½“å‰å­—èŠ‚åˆèµ·æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥</li>
<li>æ ¹æ®æœ€æ–°çš„æ ‡å‡†ï¼ŒUTF-8 ç¼–ç æœ€å¤šåªä½¿ç”¨å››ä¸ªå­—èŠ‚å»è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥åˆ°äº†è¿™ä¸€æ­¥å°±è¯´æ˜ç¼–ç é”™è¯¯äº†</li>
<li>å¦å¤–é™¤äº†è¡¨ç¤ºå‰©ä½™å­—èŠ‚æ•°çš„é‚£ä¸ªå­—èŠ‚å¤–ï¼Œå…¶ä½™å­—èŠ‚çš„æœ€é«˜ä¸¤ä½éƒ½å¿…é¡»æ˜¯ <code>10</code></li>
<li><code>U+0000</code> ä¸å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç </li>
<li><code>U+D800~U+DFFF</code> ï¼ˆå·¦å³è¾¹ç•Œä¸å¯å–ï¼‰æ˜¯ä¿ç•™æ®µï¼Œä¸å¯ä»¥ä½¿ç”¨</li>
</ol>
<p>é‚£ä¹ˆçœ‹çœ‹åˆšæ‰çš„ä¾‹å­ï¼Œæˆ‘ä»¬å–å‡ºç¬¬ä¸€ä¸ªå­—èŠ‚ <code>0xE6</code>ï¼ˆå³ <code>1110 0110</code>ï¼‰ï¼Œæˆ‘è¦é€ä¸€çš„å°è¯•æ¯ä¸€ç§æƒ…å†µï¼Œæœ€åæˆ‘ä»¬å‘ç°å®ƒçš„æœ€é«˜ 4 ä½æ˜¯ <code>1110</code> é‚£ä¹ˆå®ƒä¹‹åçš„ä¸¤ä¸ªå­—èŠ‚å’Œå®ƒä¸€èµ·è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ã€‚</p>
<ol>
<li>é¦–å…ˆæˆ‘ä»¬å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ä¸Š <code>0xF</code>ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°å®é™…çš„ 4 ä½</li>
<li>å–å‡ºç´§éšçš„ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œå°†å…¶ä¸ä¸Š <code>0x3F</code>ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°å®é™…çš„ 6 ä½</li>
<li>å–å‡ºç´§éšçš„ç¬¬ä¸‰ä¸ªå­—èŠ‚ï¼Œå°†å…¶ä¸ä¸Š <code>0x3F</code>ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°å®é™…çš„ 6 ä½</li>
</ol>
<p>æœ€åå°†è¿™ 16 ä¸ªæ•°ä½æŒ‰ç…§å–å‡ºçš„é¡ºåºä»å·¦å¾€å³æ”¾å­˜æ”¾åˆ°ä¸‰ä¸ªå­—èŠ‚ä¸­ã€‚</p>
<h2 id="ä»£ç ">ä»£ç </h2>
<p>å…ˆæ”¾ javascript çš„ï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨äº† ES6 ä¸­çš„ <code>String.prototype.codePointAt</code> æ–¹æ³•ï¼Œå› ä¸ºåœ¨ ES5 ä¸­å¯¹äºè¶…è¿‡äº† <code>0xFFFF</code> çš„å­—ç¬¦ä½¿ç”¨ <code>String.prototype.charCodeAt</code> å¹¶ä¸èƒ½æ­£ç¡®çš„è·å–å…¶ unicode ç¼–ç :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#e6db74">&#34;use strict&#34;</span>;

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#66d9ef">typeof</span> String.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">codePointAt</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span>, <span style="color:#e6db74">&#34;Current env doesn&#39;t support ECMAScript 6!&#34;</span>);

Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">equal</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">b</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">every</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">i</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">b</span>[<span style="color:#a6e22e">i</span>];
    });
};

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">unicode2utf8</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">unicode</span>) {
    <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;string&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">unicode</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">:</span> <span style="color:#a6e22e">unicode</span>;

    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span>) {
        <span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">unicode</span>]
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7FF</span>) {
        <span style="color:#66d9ef">return</span> [
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xC0</span>,
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>
        ];
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFF</span>) {
        <span style="color:#66d9ef">return</span> [
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xE0</span>,
            (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFC0</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>,
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>
        ];
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x10000</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x10FFFF</span>) {
        <span style="color:#66d9ef">return</span> [
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xF0</span>,
            (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F000</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>,
            (<span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFC0</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>,
            <span style="color:#a6e22e">unicode</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>
        ];
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;deformed unicode: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">unicode</span>);
    }
};

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;u&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0x75</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;u&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;Â©&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;Â©&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;æ±‰&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;æ±‰&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">unicode2utf8</span>(<span style="color:#e6db74">&#39;ğŸ˜„&#39;</span>).<span style="color:#a6e22e">equal</span>([<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>]), <span style="color:#e6db74">&#34;unicode2utf8 not pass &#39;ğŸ˜„&#39;&#34;</span>);

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">utf82unicode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">utf8</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">utf8</span>.<span style="color:#a6e22e">length</span>, <span style="color:#66d9ef">byte</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">0</span>];

    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;empty utf8&#39;</span>);
    }

    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">127</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">byte</span>;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
        <span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span>
                <span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
        <span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">|</span>
                ((<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span>
                (<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>)
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1E</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ul</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>) {
        <span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">byte</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">18</span>) <span style="color:#f92672">|</span>
                ((<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">|</span>
                ((<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span>
                (<span style="color:#a6e22e">utf8</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>)
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;deformed utf8: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">utf8</span>);
    }
};

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0x75</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;u&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;u&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Â©&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;Â©&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;æ±‰&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;æ±‰&#39;&#34;</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">utf82unicode</span>([<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>]) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ğŸ˜„&#39;</span>.<span style="color:#a6e22e">codePointAt</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;utf82unicode not pass &#39;ğŸ˜„&#39;&#34;</span>);
</code></pre></div><p>æ¥ä¸‹æ¥æ˜¯ golang çš„ï¼Œå…¶ä¸­çš„ <code>IsIntactUtf8</code> å‡½æ•°å°±æ˜¯æœ¬æ–‡è®¨è®ºçš„ä¸»é¢˜ - æ£€æŸ¥UTF-8ç¼–ç çš„å®Œæ•´æ€§ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uint32</span>) (<span style="color:#a6e22e">u8</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">u</span>)}, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7FF</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span> | <span style="color:#ae81ff">0xC0</span>),
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> | <span style="color:#ae81ff">0x80</span>),
		}, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFF</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">12</span> | <span style="color:#ae81ff">0xE0</span>),
			byte((<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFC0</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span> | <span style="color:#ae81ff">0x80</span>),
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> | <span style="color:#ae81ff">0x80</span>),
		}, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x10000</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x10FFFF</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">18</span> | <span style="color:#ae81ff">0xF0</span>),
			byte((<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F000</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">12</span> | <span style="color:#ae81ff">0x80</span>),
			byte((<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFC0</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span> | <span style="color:#ae81ff">0x80</span>),
			byte(<span style="color:#a6e22e">u</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> | <span style="color:#ae81ff">0x80</span>),
		}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;deformed unicode: %d&#34;</span>, <span style="color:#a6e22e">u</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestUnicode2utf8</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0x75</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x75</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;u&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0xA9</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;Â©&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0x6C49</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;æ±‰&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u8</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Unicode2utf8</span>(<span style="color:#ae81ff">0x1F604</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">u8</span>, []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>}) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;ğŸ˜„&#39;&#34;</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Utf82unicode</span>(<span style="color:#a6e22e">u8</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">u8l</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">u8</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;empty utf8&#34;</span>)
	}

	<span style="color:#a6e22e">b1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">0</span>]
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span>), <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x1F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>), <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xF</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>), <span style="color:#66d9ef">nil</span>

	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1E</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> {
		<span style="color:#66d9ef">return</span> uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x7</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">18</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
			uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>), <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;deformed utf8: %d&#34;</span>, <span style="color:#a6e22e">u8</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestUtf82unicode</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x75</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x75</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;u&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0xA9</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xA9</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;Â©&#39;&#34;</span>)
	}

	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xE6</span>, <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x89</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x6C49</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;not pass &#39;æ±‰&#39;: %x&#34;</span>, <span style="color:#a6e22e">u</span>)
	}

	<span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">Utf82unicode</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0x84</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x1F604</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;not pass &#39;ğŸ˜„&#39;&#34;</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsIntactUtf8</span>(<span style="color:#a6e22e">u8</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#a6e22e">u8l</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">u8</span>)

	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">u8l</span> {
			<span style="color:#66d9ef">break</span>
		}

		<span style="color:#a6e22e">b1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span>]
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tu</span> <span style="color:#66d9ef">uint32</span>

		<span style="color:#66d9ef">switch</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7F</span>:
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#75715e">// U+0000 encoded in two bytes: incorrect
</span><span style="color:#75715e"></span>				(<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span>] &gt; <span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] &gt; <span style="color:#ae81ff">0x80</span>) {
				<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span> {
				<span style="color:#a6e22e">tu</span> = uint32(<span style="color:#a6e22e">b1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xF</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span> |
					uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span> |
					uint32(<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span>)

				<span style="color:#75715e">// UTF-8 prohibits encoding character numbers between U+D800 and U+DFFF
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tu</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">tu</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#f92672">&amp;&amp;</span> !(<span style="color:#a6e22e">tu</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0xD800</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">tu</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xDFFF</span>) {
					<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
				}
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">b1</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1E</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u8l</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x7</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x4</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3F</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xF</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&amp;&amp;</span>
				<span style="color:#a6e22e">u8</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xC0</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x80</span> {
				<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
		<span style="color:#66d9ef">default</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
		}
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">u8l</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ValidTest</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">in</span>  <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">out</span> <span style="color:#66d9ef">bool</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">validTests</span> = []<span style="color:#a6e22e">ValidTest</span>{
	{<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;abc&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;Ğ–&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;Ğ–Ğ–&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;Ğ±Ñ€ÑĞ´-Ğ›Ğ“Ğ¢Ğœ&#34;</span>, <span style="color:#66d9ef">true</span>},
	{<span style="color:#e6db74">&#34;â˜ºâ˜»â˜¹&#34;</span>, <span style="color:#66d9ef">true</span>},
	{string([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">250</span>}), <span style="color:#66d9ef">false</span>},
	{string([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">67</span>}), <span style="color:#66d9ef">false</span>},
	{<span style="color:#e6db74">&#34;a\uFFFDb&#34;</span>, <span style="color:#66d9ef">true</span>},
	{string(<span style="color:#e6db74">&#34;\xF4\x8F\xBF\xBF&#34;</span>), <span style="color:#66d9ef">true</span>},      <span style="color:#75715e">// U+10FFFF
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xF4\x90\x80\x80&#34;</span>), <span style="color:#66d9ef">false</span>},     <span style="color:#75715e">// U+10FFFF+1; out of range
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xF7\xBF\xBF\xBF&#34;</span>), <span style="color:#66d9ef">false</span>},     <span style="color:#75715e">// 0x1FFFFF; out of range
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xFB\xBF\xBF\xBF\xBF&#34;</span>), <span style="color:#66d9ef">false</span>}, <span style="color:#75715e">// 0x3FFFFFF; out of range
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xc0\x80&#34;</span>), <span style="color:#66d9ef">false</span>},             <span style="color:#75715e">// U+0000 encoded in two bytes: incorrect
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xed\xa0\x80&#34;</span>), <span style="color:#66d9ef">false</span>},         <span style="color:#75715e">// U+D800 high surrogate (sic)
</span><span style="color:#75715e"></span>	{string(<span style="color:#e6db74">&#34;\xed\xbf\xbf&#34;</span>), <span style="color:#66d9ef">false</span>},         <span style="color:#75715e">// U+DFFF low surrogate (sic)
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestIsIntactUtf8</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">tt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">validTests</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">IsIntactUtf8</span>([]byte(<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">in</span>)) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">out</span> {
			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;[CASE %d] IsIntactUtf8(%q) = %v; want %v&#34;</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">in</span>, !<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">out</span>)
		}
	}
}
</code></pre></div><p>åŸç†ä»¥åŠä»£ç éƒ½ç»™å‡ºæ¥äº†ï¼Œåº”è¯¥ä¼šå¯¹ UTF-8 ä»¥åŠ UTF-8 ä¸ Unicode ä¹‹é—´çš„å…³ç³»ä¸æ˜äº†çš„åŒå­¦æœ‰äº›å¸®åŠ©å§ã€‚</p>

    <a href="/"> >> Home</a>
  </main>
</div>
    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/hsiaosiyuan0">GitHub</a>
      
    </footer>
  </body>
</html>

