<!DOCTYPE html><html><head><title>node-addon</title><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1, user-scalable=no, viewport-fit=cover"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.5.0/themes/prism-vsc-dark-plus.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/toolbar/prism-toolbar.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-highlight/prism-line-highlight.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/material-icons@0.3.1/iconfont/material-icons.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/material-icons@0.3.1/css/material-icons.min.css"/><link rel="stylesheet" href="/outlet__outlets_default_tsx.css"/><link rel="stylesheet" href="/shared-outlets_index_scss.css"/><link rel="stylesheet" href="/pages/post.css"/></head><body><div id="__gadget__"><div><div class="" style="position:fixed;top:0;left:0;height:2px;background:transparent;z-index:99999999999;width:100%"><div style="height:100%;background:#2998ff;transition:all 500ms ease;width:0%"><div style="box-shadow:0 0 10px #2998ff, 0 0 10px #2998ff;width:5%;opacity:1;position:absolute;height:100%;transition:all 500ms ease;transform:rotate(3deg) translate(0px, -4px);left:-10rem"></div></div></div><div class="_3k0uOgdSRfNa0MZs6QS7ku"><div class="_1G63502GZaEXBXykcWz6cX">The hard ways</div><div class="_3HRY5_KLp8kngNq9437Zqi"><a href="/sitemap.html">all</a></div></div><div class="Z_a6ax5LrTSVASNRR2aN6 _11dH37BK8JkWofQgbOzM4L"><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>v8</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/v8/debug-v8-in-vscode.html"><i class=""></i><span>debug-v8-in-vscode</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/v8/common-data-types.html"><i class=""></i><span>v8 常见数据类型</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>deno</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/deno/native-plugin.html"><i class=""></i><span>deno native plugin 内部实现机制</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>crypto</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/crypto/brief-crypto.html"><i class=""></i><span>加密算法调研</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>nodejs</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/Cluster 模块分析.html"><i class=""></i><span>Cluster 模块分析</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/build-from-source.html"><i class=""></i><span>build-from-source</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/node-addon.html"><i class=""></i><span>node-addon</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/common-snippet.html"><i class=""></i><span>common-snippet</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/heap-snapshot.html"><i class=""></i><span>v8 Heapsnapshot 文件解析</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/libuv.html"><i class=""></i><span>Libuv 之 - 只看这篇是不够的</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/object-in-v8.html"><i class=""></i><span>Objects in V8</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/node-on-libuv.html"><i class=""></i><span>Libuv 之上的 Node</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>websocket</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/websocket/WebSocket 协议 1~4 节.html"><i class=""></i><span>WebSocket 协议 1~4 节</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/websocket/WebSocket 协议 5~10 节.html"><i class=""></i><span>WebSocket 协议 5~10 节</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>assembly</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/assembly/汇编语言学习小结.html"><i class=""></i><span>汇编语言学习小结</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>typescript</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/typescript/decorator.html"><i class=""></i><span>Decorator in babel and tsc</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>rust</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/rust/lifetime.html"><i class=""></i><span>Lifetime</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>oop</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/oop/ioc.html"><i class=""></i><span>midway 分析</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>php</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/php/为什么 PHP 不适合长时间运行.html"><i class=""></i><span>为什么 PHP 不适合长时间运行</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>blockchain</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/blockchain/crypto-conditions 简述.html"><i class=""></i><span>crypto-conditions 简述</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/blockchain/实用拜占庭容错简介.html"><i class=""></i><span>实用拜占庭容错简介</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>browser</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/browser/浏览器异步加载和同源策略.html"><i class=""></i><span>浏览器异步加载和同源策略</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>cpp</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/cpp/the-as-if-rule.html"><i class=""></i><span>The as-if rule</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>work</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/work/parsing-in-practice.html"><i class=""></i><span>Parsing in practice</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>os</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/大小端序.html"><i class=""></i><span>大小端序</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/UTF-8 编码及检查其完整性.html"><i class=""></i><span>UTF-8 编码及检查其完整性</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/魔数0x7c00.html"><i class=""></i><span>魔数 0x7c00</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/字符集和字符编码.html"><i class=""></i><span>字符集和字符编码</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>javascript</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/generator function.html"><i class=""></i><span>Generator Function</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/解析 JSON 的成本.html"><i class=""></i><span>解析 JSON 的成本</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/Javascript 内部的字符编码.html"><i class=""></i><span>Javascript 内部的字符编码</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/闭包的作用.html"><i class=""></i><span>闭包的作用</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/闭包是什么.html"><i class=""></i><span>闭包是什么</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>static-analysis</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/static-analysis/ternjs.html"><i class=""></i><span>使用 Rust 重写 ternjs</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>craft</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/craft/create_your_own_lang.html"><i class=""></i><span>制作一个属于自己的语言</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>go</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/go/bad_in_generic_syntax.html"><i class=""></i><span>Go 语言中的 Generic 设计缺陷</span></a><ul></ul></div></li></ul></div></div><div class="rWpFqfkPbEcRx8xnnjlEm line-numbers"><div><div><h2 id="前言">前言</h2>
<p>本文将简单介绍 node.js 的扩展（C++ addons），并实现一个 nan 版的 hello-world 扩展</p>
<h2 id="扩展的实现方式">扩展的实现方式</h2>
<p>按照官方文档 <a href="https://nodejs.org/api/addons.html">C++ addons</a> 的描述，有三种方式来实现扩展：</p>
<ul>
<li>Node-API</li>
<li>nan</li>
<li>直接使用 node.js 内部 re-exported 的模块，比如：libuv, OpenSSL, V8 and zlib</li>
</ul>
<h3 id="相同点">相同点</h3>
<p>Node-API 和 nan 都是对 node.js 内部模块的封装，目的是为了让扩展的编写者可以较为轻松的应对底层 API 的兼容性问题：</p>
<p><img src="https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7720626698/8477/e7b3/c62e/275c85fdad05fc2530b42e05b3c26c6b.png" alt=""/></p>
<h3 id="不同点">不同点</h3>
<p>Node-API 和 nan 的不同点在于：</p>
<ul>
<li>Node-API 使用 C 来提供 API，这样方便其他运行环境进行接入。而 nan 是 C++ 的 API，因此其他环境接入时，在没有出现 Node-API 之前，都需要先用 C 将 C++ 的 API 封装一遍（主要因为 C++ 的 <a href="https://en.wikipedia.org/wiki/Name_mangling">name mangling</a> 和 C 的不一样，而 C 被其他运行环境的支持度更高）</li>
<li>两者的另外一点不同在于，Node-API 和 nan 提供的 API 集合是不同的。上面已经提到过，API 抽象层的目的就是为了解决兼容性问题，而 Node-API 的 API 集合作为 nan 的子集来说，具有更高的稳定性。这里的稳定性只是在各个版本之间保持一致的行为。哪些 API 可以从 nan 加入到 Node-API，是受制于底层模块的 API 的稳定性的，只有那些底层模块几乎不会变更（或者细微变更可以在 Node-API 做 polyfill）的，才会加入到 Node-API 中</li>
</ul>
<h2 id="如何选择">如何选择</h2>
<p>具体如何选择 Node-API 还是 nan，需要根据我们的扩展类型来确定</p>
<p>大部分情况下，扩展的目的是为了弥补 JS 在 CPU 密集型任务上的不足，这些扩展基本上只是往 JS 环境注入一个（或多个）方法，接收一些参数，然后内部处理后，再将处理结果通过回调或者 Promise 返回给 JS 环境。这样的情况基本使用 Node-API 就足够了（与 nan 不同，为了符合其稳定的使命，使用 Node-API 方式，将只能使用 Node-API 提供的 API）</p>
<p>而某些情况，比如需要编写获取应用运行时状态的，也就是需要和运行时深度交互的，这样的扩展就需要使用 nan 的方式（或者当某些 API 没有抽象到 nan，则直接使用 re-exported 的模块）</p>
<h2 id="HelloWorld">Hello World</h2>
<p>为了方便大家编写扩展时可以有参照物，官方准备了 <a href="https://github.com/nodejs/node-addon-examples">node-addon-examples</a>。我们的 hello-world 就是基于它 <a href="https://github.com/nodejs/node-addon-examples/tree/main/1_hello_world/nan">这里</a> 的实现</p>
<p>我们将使用 VSCode 进行开发，首先需要安装 <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">VSCode C/C++ Extension</a></p>
<p>这里默认大家已经配置好基本的 C/C++ 开发环境，如果没有的话，请参考 <a href="https://code.visualstudio.com/docs/cpp/">Using C++ in VS Code</a>（如果没有按平台跳转，需要手动选择左侧菜单）</p>
<p>我们直接把 <a href="https://github.com/nodejs/node-addon-examples/tree/main/1_hello_world/nan">这里</a> 的代码按文件拷贝到本地目录后，还需要做一些微调，让开发更有体验。如果觉得麻烦，也可以直接克隆这个<a href="https://github.com/hsiaosiyuan0/node_addon_hello">仓库</a></p>
<h3 id="设置VSCodeC/C++扩展">设置 VSCode C/C++ 扩展</h3>
<p>首先设定一下 VSCode C/C++ 扩展的头文件搜索路径，这样可以方便补全和查看定义</p>
<p>可以按下面的步骤进行设定：</p>
<ol>
<li>打开 <code>hello.cc</code> 文件，此时文件头部应该会提示找不到头文件：</li>
</ol>
<ol start="2">
<li>将光标定位到第一行，此时会出现黄色的感叹号:</li>
</ol>
<ol start="3">
<li>点击黄色感叹号，我们可以选择 「Add to ...」或者「Edit &quot;includePath&quot; setting」</li>
</ol>
<p>如果没有出现「Add to ...」，则选择「Edit &quot;includePath&quot; setting」，然后将命令：</p>
<pre><code class="language-bash">echo `which node` | sed &#x27;s=bin/node$=include/node=&#x27;
</code></pre>
<p>的运行结果粘贴到下一步提到的位置中</p>
<ol start="4">
<li>点击上一步的选项后，会在根目录下生成 <code>.vscode/c_cpp_properties.json</code> 文件，后续我们可以把未能自动识别的头文件路径加入到其中的 <code>includePath</code> 部分：</li>
</ol>
<ol start="5">
<li>编译好后保存该文件，插件内部经过短暂的构建索引之后，我们就可以在源码中查看方法的定义了</li>
</ol>
<h2 id="设置代码风格">设置代码风格</h2>
<p>可以在项目根目录下创建一个 <code>.clang-format</code> 文件，然后将下面的内容粘贴进去：</p>
<pre><code class="language-json">BasedOnStyle: Google
</code></pre>
<p>这样我们格式化代码的时候，就可以应用 Google 的 CPP 代码风格了，更多的风格可以在这里找到 <a href="https://clang.llvm.org/docs/ClangFormatStyleOptions.html#configurable-format-style-options">Configurable Format Style Options</a></p>
<h2 id="增加几个命令">增加几个命令</h2>
<p>我们还需要在 package.json 中增加几个命令：</p>
<pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;configure&quot;: &quot;node-gyp configure&quot;,
    &quot;build&quot;: &quot;node-gyp build&quot;,
    &quot;rebuild&quot;: &quot;node-gyp rebuild&quot;,
  }
}
</code></pre>
<p>这些其实都是 <code>node-gyp</code> 的命令，更多常用命令可以在 <a href="https://www.npmjs.com/package/node-gyp#commands">这里</a> 找到</p>
<h2 id="运行">运行</h2>
<p>最后我们通过下面的命令来运行插件：</p>
<pre><code class="language-bash">npm i
npm run build
node hello.js
</code></pre>
<p>后续我们修改 C++ 文件后，只需要运行：</p>
<pre><code class="language-bash">npm run build
node hello.js
</code></pre></div></div></div><div class="_3a4jt6lr4yLRJnQge009wv"><ul><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#前言">前言</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#扩展的实现方式">扩展的实现方式</a></span></div><ul><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#相同点">相同点</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#不同点">不同点</a></span></div><ul></ul></div></li></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#如何选择">如何选择</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#HelloWorld">Hello World</a></span></div><ul><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#设置VSCodeC/C++扩展">设置 VSCode C/C++ 扩展</a></span></div><ul></ul></div></li></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#设置代码风格">设置代码风格</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#增加几个命令">增加几个命令</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#运行">运行</a></span></div><ul></ul></div></li></ul></div><div class="_1UY_ItV2UTWKutKs5b7NKg">Made with <a target="_blank" href="https://github.com/hsiaosiyuan0/gadget">gadget</a></div></div></div><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-core.min.js" data-manual="true"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-markup.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-clike.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-json.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-javascript.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-jsx.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-typescript.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-tsx.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-bash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-python.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-xml-doc.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-docker.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-rust.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-nasm.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-c.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-cpp.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-xml-doc.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-go.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/toolbar/prism-toolbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-highlight/prism-line-highlight.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/show-language/prism-show-language.min.js"></script><script src="https://cdn.jsdelivr.net/gh/cferdinandi/gumshoe@5.1.1/dist/gumshoe.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react@16.14.0/umd/react.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react-dom@16.14.0/umd/react-dom.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react@16.14.0/umd/react.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react-dom@16.14.0/umd/react-dom.production.min.js"></script><script>window["__gadget__"]={"initialProps":{"data":{"post":{"filename":"node-addon","rawMeta":{"title":"node-addon"},"content":"## 前言\n\n本文将简单介绍 node.js 的扩展（C++ addons），并实现一个 nan 版的 hello-world 扩展\n\n## 扩展的实现方式\n\n按照官方文档 [C++ addons](https://nodejs.org/api/addons.html) 的描述，有三种方式来实现扩展：\n\n- Node-API\n- nan\n- 直接使用 node.js 内部 re-exported 的模块，比如：libuv, OpenSSL, V8 and zlib\n\n### 相同点\n\nNode-API 和 nan 都是对 node.js 内部模块的封装，目的是为了让扩展的编写者可以较为轻松的应对底层 API 的兼容性问题：\n\n![](https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7720626698/8477/e7b3/c62e/275c85fdad05fc2530b42e05b3c26c6b.png)\n\n### 不同点\n\nNode-API 和 nan 的不同点在于：\n\n- Node-API 使用 C 来提供 API，这样方便其他运行环境进行接入。而 nan 是 C++ 的 API，因此其他环境接入时，在没有出现 Node-API 之前，都需要先用 C 将 C++ 的 API 封装一遍（主要因为 C++ 的 [name mangling](https://en.wikipedia.org/wiki/Name_mangling) 和 C 的不一样，而 C 被其他运行环境的支持度更高）\n- 两者的另外一点不同在于，Node-API 和 nan 提供的 API 集合是不同的。上面已经提到过，API 抽象层的目的就是为了解决兼容性问题，而 Node-API 的 API 集合作为 nan 的子集来说，具有更高的稳定性。这里的稳定性只是在各个版本之间保持一致的行为。哪些 API 可以从 nan 加入到 Node-API，是受制于底层模块的 API 的稳定性的，只有那些底层模块几乎不会变更（或者细微变更可以在 Node-API 做 polyfill）的，才会加入到 Node-API 中\n\n## 如何选择\n\n具体如何选择 Node-API 还是 nan，需要根据我们的扩展类型来确定\n\n大部分情况下，扩展的目的是为了弥补 JS 在 CPU 密集型任务上的不足，这些扩展基本上只是往 JS 环境注入一个（或多个）方法，接收一些参数，然后内部处理后，再将处理结果通过回调或者 Promise 返回给 JS 环境。这样的情况基本使用 Node-API 就足够了（与 nan 不同，为了符合其稳定的使命，使用 Node-API 方式，将只能使用 Node-API 提供的 API）\n\n而某些情况，比如需要编写获取应用运行时状态的，也就是需要和运行时深度交互的，这样的扩展就需要使用 nan 的方式（或者当某些 API 没有抽象到 nan，则直接使用 re-exported 的模块）\n\n## Hello World\n\n为了方便大家编写扩展时可以有参照物，官方准备了 [node-addon-examples](https://github.com/nodejs/node-addon-examples)。我们的 hello-world 就是基于它 [这里](https://github.com/nodejs/node-addon-examples/tree/main/1_hello_world/nan) 的实现\n\n我们将使用 VSCode 进行开发，首先需要安装 [VSCode C/C++ Extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools)\n\n这里默认大家已经配置好基本的 C/C++ 开发环境，如果没有的话，请参考 [Using C++ in VS Code](https://code.visualstudio.com/docs/cpp/)（如果没有按平台跳转，需要手动选择左侧菜单）\n\n我们直接把 [这里](https://github.com/nodejs/node-addon-examples/tree/main/1_hello_world/nan) 的代码按文件拷贝到本地目录后，还需要做一些微调，让开发更有体验。如果觉得麻烦，也可以直接克隆这个[仓库](https://github.com/hsiaosiyuan0/node_addon_hello)\n\n### 设置 VSCode C/C++ 扩展\n\n首先设定一下 VSCode C/C++ 扩展的头文件搜索路径，这样可以方便补全和查看定义\n\n可以按下面的步骤进行设定：\n\n1. 打开 `hello.cc` 文件，此时文件头部应该会提示找不到头文件：\n\n<img src=\"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7721734954/292f/8d9e/efc4/c7de1eb31d87b70dd781a35f1265e1f7.png\" width=\"500\" />\n\n2. 将光标定位到第一行，此时会出现黄色的感叹号:\n\n<img src=\"https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7721774157/a600/ee82/d57b/fc7f1fbc7c1c364b7a58451b2a137019.png\" width=\"500\" />\n\n3. 点击黄色感叹号，我们可以选择 「Add to ...」或者「Edit \"includePath\" setting」\n\n<img src=\"https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7721782714/80ea/86e2/4c8a/799c9f2a14b362d0c76d6647fe4eabb1.png\" width=\"500\" />\n\n如果没有出现「Add to ...」，则选择「Edit \"includePath\" setting」，然后将命令：\n\n```bash\necho `which node` | sed 's=bin/node$=include/node='\n```\n\n的运行结果粘贴到下一步提到的位置中\n\n4. 点击上一步的选项后，会在根目录下生成 `.vscode/c_cpp_properties.json` 文件，后续我们可以把未能自动识别的头文件路径加入到其中的 `includePath` 部分：\n\n<img src=\"https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7721921161/dad7/c390/925a/67ec616dc19db2e9c6c4100338d299f3.png\" width=\"500\" />\n\n5. 编译好后保存该文件，插件内部经过短暂的构建索引之后，我们就可以在源码中查看方法的定义了\n\n## 设置代码风格\n\n可以在项目根目录下创建一个 `.clang-format` 文件，然后将下面的内容粘贴进去：\n\n```json\nBasedOnStyle: Google\n```\n\n这样我们格式化代码的时候，就可以应用 Google 的 CPP 代码风格了，更多的风格可以在这里找到 [Configurable Format Style Options](https://clang.llvm.org/docs/ClangFormatStyleOptions.html#configurable-format-style-options)\n\n## 增加几个命令\n\n我们还需要在 package.json 中增加几个命令：\n\n```json\n{\n  \"scripts\": {\n    \"configure\": \"node-gyp configure\",\n    \"build\": \"node-gyp build\",\n    \"rebuild\": \"node-gyp rebuild\",\n  }\n}\n```\n\n这些其实都是 `node-gyp` 的命令，更多常用命令可以在 [这里](https://www.npmjs.com/package/node-gyp#commands) 找到\n\n## 运行\n\n最后我们通过下面的命令来运行插件：\n\n```bash\nnpm i\nnpm run build\nnode hello.js\n```\n\n后续我们修改 C++ 文件后，只需要运行：\n\n```bash\nnpm run build\nnode hello.js\n```\n","slug":"/nodejs/node-addon","toc":[{"name":"前言","depth":2,"anchor":"#前言","children":[]},{"name":"扩展的实现方式","depth":2,"anchor":"#扩展的实现方式","children":[{"name":"相同点","depth":3,"anchor":"#相同点","children":[]},{"name":"不同点","depth":3,"anchor":"#不同点","children":[]}]},{"name":"如何选择","depth":2,"anchor":"#如何选择","children":[]},{"name":"Hello World","depth":2,"anchor":"#HelloWorld","children":[{"name":"设置 VSCode C/C++ 扩展","depth":3,"anchor":"#设置VSCodeC/C++扩展","children":[]}]},{"name":"设置代码风格","depth":2,"anchor":"#设置代码风格","children":[]},{"name":"增加几个命令","depth":2,"anchor":"#增加几个命令","children":[]},{"name":"运行","depth":2,"anchor":"#运行","children":[]}],"keywords":[],"mtime":1615393171071},"catalog":[{"name":"v8","url":"/post/v8","children":[{"name":"debug-v8-in-vscode","url":"/post/v8/debug-v8-in-vscode.html","children":[]},{"name":"v8 常见数据类型","url":"/post/v8/common-data-types.html","children":[]}]},{"name":"deno","url":"/post/deno","children":[{"name":"deno native plugin 内部实现机制","url":"/post/deno/native-plugin.html","children":[]}]},{"name":"crypto","url":"/post/crypto","children":[{"name":"加密算法调研","url":"/post/crypto/brief-crypto.html","children":[]}]},{"name":"nodejs","url":"/post/nodejs","children":[{"name":"Cluster 模块分析","url":"/post/nodejs/Cluster 模块分析.html","children":[]},{"name":"build-from-source","url":"/post/nodejs/build-from-source.html","children":[]},{"name":"node-addon","url":"/post/nodejs/node-addon.html","children":[]},{"name":"common-snippet","url":"/post/nodejs/common-snippet.html","children":[]},{"name":"v8 Heapsnapshot 文件解析","url":"/post/nodejs/heap-snapshot.html","children":[]},{"name":"Libuv 之 - 只看这篇是不够的","url":"/post/nodejs/libuv.html","children":[]},{"name":"Objects in V8","url":"/post/nodejs/object-in-v8.html","children":[]},{"name":"Libuv 之上的 Node","url":"/post/nodejs/node-on-libuv.html","children":[]}]},{"name":"websocket","url":"/post/websocket","children":[{"name":"WebSocket 协议 1~4 节","url":"/post/websocket/WebSocket 协议 1~4 节.html","children":[]},{"name":"WebSocket 协议 5~10 节","url":"/post/websocket/WebSocket 协议 5~10 节.html","children":[]}]},{"name":"assembly","url":"/post/assembly","children":[{"name":"汇编语言学习小结","url":"/post/assembly/汇编语言学习小结.html","children":[]}]},{"name":"typescript","url":"/post/typescript","children":[{"name":"Decorator in babel and tsc","url":"/post/typescript/decorator.html","children":[]}]},{"name":"rust","url":"/post/rust","children":[{"name":"Lifetime","url":"/post/rust/lifetime.html","children":[]}]},{"name":"oop","url":"/post/oop","children":[{"name":"midway 分析","url":"/post/oop/ioc.html","children":[]}]},{"name":"php","url":"/post/php","children":[{"name":"为什么 PHP 不适合长时间运行","url":"/post/php/为什么 PHP 不适合长时间运行.html","children":[]}]},{"name":"blockchain","url":"/post/blockchain","children":[{"name":"crypto-conditions 简述","url":"/post/blockchain/crypto-conditions 简述.html","children":[]},{"name":"实用拜占庭容错简介","url":"/post/blockchain/实用拜占庭容错简介.html","children":[]}]},{"name":"browser","url":"/post/browser","children":[{"name":"浏览器异步加载和同源策略","url":"/post/browser/浏览器异步加载和同源策略.html","children":[]}]},{"name":"cpp","url":"/post/cpp","children":[{"name":"The as-if rule","url":"/post/cpp/the-as-if-rule.html","children":[]}]},{"name":"work","url":"/post/work","children":[{"name":"Parsing in practice","url":"/post/work/parsing-in-practice.html","children":[]}]},{"name":"os","url":"/post/os","children":[{"name":"大小端序","url":"/post/os/大小端序.html","children":[]},{"name":"UTF-8 编码及检查其完整性","url":"/post/os/UTF-8 编码及检查其完整性.html","children":[]},{"name":"魔数 0x7c00","url":"/post/os/魔数0x7c00.html","children":[]},{"name":"字符集和字符编码","url":"/post/os/字符集和字符编码.html","children":[]}]},{"name":"javascript","url":"/post/javascript","children":[{"name":"Generator Function","url":"/post/javascript/generator function.html","children":[]},{"name":"解析 JSON 的成本","url":"/post/javascript/解析 JSON 的成本.html","children":[]},{"name":"Javascript 内部的字符编码","url":"/post/javascript/Javascript 内部的字符编码.html","children":[]},{"name":"闭包的作用","url":"/post/javascript/闭包的作用.html","children":[]},{"name":"闭包是什么","url":"/post/javascript/闭包是什么.html","children":[]}]},{"name":"static-analysis","url":"/post/static-analysis","children":[{"name":"使用 Rust 重写 ternjs","url":"/post/static-analysis/ternjs.html","children":[]}]},{"name":"craft","url":"/post/craft","children":[{"name":"制作一个属于自己的语言","url":"/post/craft/create_your_own_lang.html","children":[]}]},{"name":"go","url":"/post/go","children":[{"name":"Go 语言中的 Generic 设计缺陷","url":"/post/go/bad_in_generic_syntax.html","children":[]}]}],"title":"The hard ways"}},"currentRoute":{"pattern":"/post","href":{"pathname":"/post"}},"pageModules":{"/index":["/pages/index.js"],"/post":["/pages/post.css","/pages/post.js"],"/sitemap":["/pages/sitemap.css","/pages/sitemap.js"],"/post/*":["/pages/post.css","/pages/post.js"]},"router":{"basename":"/","hash":false,"routes":["/index","/post","/sitemap","/post/*"]}};</script><script crossorigin="anonymous" src="/app.js"></script><script crossorigin="anonymous" src="/foundation.js"></script><script crossorigin="anonymous" src="/lib.js"></script><script crossorigin="anonymous" src="/shared-pages_post_tsx.js"></script><script crossorigin="anonymous" src="/pages/post.js"></script></body></html>