<!DOCTYPE html><html><head><title>deno native plugin 内部实现机制</title><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1, user-scalable=no, viewport-fit=cover"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.5.0/themes/prism-vsc-dark-plus.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/toolbar/prism-toolbar.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-highlight/prism-line-highlight.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/material-icons@0.3.1/iconfont/material-icons.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/material-icons@0.3.1/css/material-icons.min.css"/><link rel="stylesheet" href="/outlet__outlets_default_tsx.css"/><link rel="stylesheet" href="/pages/post.css"/></head><body><a id="fork-me" href="https://github.com/hsiaosiyuan0/hsiaosiyuan0.github.io" style="position:fixed;top:0;right:0;border:0;width:150px;height:150px;z-index:3000"><img style="position:absolute;top:0;right:0;border:0" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"/></a><div id="__gadget__"><div><div class="" style="position:fixed;top:0;left:0;height:2px;background:transparent;z-index:99999999999;width:100%"><div style="height:100%;background:#2998ff;transition:all 500ms ease;width:0%"><div style="box-shadow:0 0 10px #2998ff, 0 0 10px #2998ff;width:5%;opacity:1;position:absolute;height:100%;transition:all 500ms ease;transform:rotate(3deg) translate(0px, -4px);left:-10rem"></div></div></div><div class="_3k0uOgdSRfNa0MZs6QS7ku"><div class="_1G63502GZaEXBXykcWz6cX">The hard ways</div><div class="_3HRY5_KLp8kngNq9437Zqi"><a href="/sitemap.html">all</a></div></div><div class="Z_a6ax5LrTSVASNRR2aN6 _11dH37BK8JkWofQgbOzM4L"><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>v8</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/v8/debug-v8-in-vscode.html"><i class=""></i><span>debug-v8-in-vscode</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/v8/common-data-types.html"><i class=""></i><span>v8 常见数据类型</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>deno</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/deno/native-plugin.html"><i class=""></i><span>deno native plugin 内部实现机制</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>crypto</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/crypto/brief-crypto.html"><i class=""></i><span>加密算法调研</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>nodejs</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/Cluster 模块分析.html"><i class=""></i><span>Cluster 模块分析</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/build-from-source.html"><i class=""></i><span>build-from-source</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/node-addon.html"><i class=""></i><span>node-addon</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/common-snippet.html"><i class=""></i><span>common-snippet</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/heap-snapshot.html"><i class=""></i><span>v8 Heapsnapshot 文件解析</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/libuv.html"><i class=""></i><span>Libuv 之 - 只看这篇是不够的</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/object-in-v8.html"><i class=""></i><span>Objects in V8</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/nodejs/node-on-libuv.html"><i class=""></i><span>Libuv 之上的 Node</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>websocket</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/websocket/WebSocket 协议 1~4 节.html"><i class=""></i><span>WebSocket 协议 1~4 节</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/websocket/WebSocket 协议 5~10 节.html"><i class=""></i><span>WebSocket 协议 5~10 节</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>assembly</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/assembly/汇编语言学习小结.html"><i class=""></i><span>汇编语言学习小结</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>typescript</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/typescript/decorator.html"><i class=""></i><span>Decorator in babel and tsc</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>rust</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/rust/lifetime.html"><i class=""></i><span>Lifetime</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>oop</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/oop/ioc.html"><i class=""></i><span>midway 分析</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>php</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/php/为什么 PHP 不适合长时间运行.html"><i class=""></i><span>为什么 PHP 不适合长时间运行</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>blockchain</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/blockchain/crypto-conditions 简述.html"><i class=""></i><span>crypto-conditions 简述</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/blockchain/实用拜占庭容错简介.html"><i class=""></i><span>实用拜占庭容错简介</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>browser</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/browser/浏览器异步加载和同源策略.html"><i class=""></i><span>浏览器异步加载和同源策略</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>cpp</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/cpp/the-as-if-rule.html"><i class=""></i><span>The as-if rule</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>work</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/work/parsing-in-practice.html"><i class=""></i><span>Parsing in practice</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>os</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/大小端序.html"><i class=""></i><span>大小端序</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/UTF-8 编码及检查其完整性.html"><i class=""></i><span>UTF-8 编码及检查其完整性</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/魔数0x7c00.html"><i class=""></i><span>魔数 0x7c00</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/os/字符集和字符编码.html"><i class=""></i><span>字符集和字符编码</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>javascript</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/generator function.html"><i class=""></i><span>Generator Function</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/解析 JSON 的成本.html"><i class=""></i><span>解析 JSON 的成本</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/Javascript 内部的字符编码.html"><i class=""></i><span>Javascript 内部的字符编码</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/闭包的作用.html"><i class=""></i><span>闭包的作用</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/javascript/闭包是什么.html"><i class=""></i><span>闭包是什么</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>static-analysis</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/static-analysis/ternjs.html"><i class=""></i><span>使用 Rust 重写 ternjs</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>react</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/react/build-from-source.html"><i class=""></i><span>build-from-source</span></a><ul></ul></div></li><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/react/bootstrap.html"><i class=""></i><span>bootstrap</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class="mi mi-arrow-drop-down"></i><span>ripplet</span></div><ul><li><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><a class="_15sI_H5F3ci3xYIfWDB4vZ" style="padding-left:15px" href="/post/ripplet/create_your_own_lang.html"><i class=""></i><span>码个自己的语言</span></a><ul></ul></div></li></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class=""></i><span>dev</span></div><ul></ul></div><div class="_3quX88R9lR5BSdfAKHIoaF _1lO9qEBu6kafjPHlc111Kf"><div class="_15sI_H5F3ci3xYIfWDB4vZ"><i class=""></i><span>esbuild</span></div><ul></ul></div></div><div class="rWpFqfkPbEcRx8xnnjlEm line-numbers"><div><div><h1 id="denonativeplugin内部实现机制">deno native plugin 内部实现机制</h1>
<h2 id="demo">demo</h2>
<p>可以使用 <a href="https://github.com/chiefbiiko/create-deno-plugin">create-deno-plugin</a> 创建一个插件工程，方便对插件有个具象化的感知</p>
<h2 id="插件注册">插件注册</h2>
<ol>
<li>
<p>首先是载入 dynamic library 见 <a href="https://github.com/denoland/deno/blob/master/cli/ops/plugin.rs#L59">deno/cli/ops/plugin.rs#L59</a>，并找到模块中的符号 <code>deno_plugin_init</code>，这是 deno 扩展机制和插件开发者约定的入口</p>
</li>
<li>
<p>然后调用模块中的 <code>deno_plugin_init</code> 方法，来注册模块希望暴露给 js 环境的方法，注册的步骤见 <a href="https://github.com/denoland/deno/blob/master/cli/ops/plugin.rs#L71">deno/cli/ops/plugin.rs#L71</a></p>
</li>
<li>
<p>模块中是以何种形式将自己的方法注册的呢，详见 <a href="https://github.com/webview/webview_deno/blob/master/src/lib.rs#L31">webview_deno/src/lib.rs#L31</a>，挑部分简单看下：</p>
</li>
</ol>
<pre><code class="language-rust">#[no_mangle] // 很重要，否则第2步就找不到符号了，因为 rust 支持重载之类的特性，所以编译后函数名会有变动
pub fn deno_plugin_init(interface: &amp;mut dyn Interface) {
  interface.register_op(&quot;webview_free&quot;, webview_free);
}

#[json_op]
fn webview_free(
  json: Value,
  _zero_copy: &amp;mut [ZeroCopyBuf],
) -&gt; Result&lt;Value, AnyError&gt; {
  // ...
}
</code></pre>
<p>可以看到，就是很语义化的一条注册语句 <code>register_op</code></p>
<ol start="4">
<li>简单看一下 <code>register_op</code> 的实现，详见 <a href="https://github.com/denoland/deno/blob/master/cli/ops/plugin.rs#L103">deno/cli/ops/plugin.rs#L103</a></li>
</ol>
<pre><code class="language-rust">fn register_op(
  &amp;mut self,
  name: &amp;str,
  dispatch_op_fn: plugin_api::DispatchOpFn,
) -&gt; OpId {
  // ...
  let plugin_op_fn = move |state_rc: Rc&lt;RefCell&lt;OpState&gt;&gt;,
                            mut zero_copy: BufVec| {
    // ...
    let op = dispatch_op_fn(&amp;mut interface, &amp;mut zero_copy);
    // ...
  };
  self
    .state
    .op_table
    .register_op(name, metrics_op(Box::new(plugin_op_fn)))
}
</code></pre>
<p><code>dispatch_op_fn</code> 是插件注册的方法，比如上文的 <code>webview_free</code>，然后包装成另一个函数 <code>plugin_op_fn</code> 后注册，目前看来包装的目的应该是做一个出入参的调整，包装好后的函数被注册到了 <code>state.op_table</code> 中</p>
<p>如果进入 <code>metrics_op</code> 的实现查看的话，会发现它又包了一层 <a href="https://github.com/denoland/deno/blob/master/cli/metrics.rs#L82">deno/cli/metrics.rs#L82</a> 暂时看不知道原因</p>
<p>注册的步骤就到此为止了，流程可以大致梳理为：</p>
<ul>
<li>从 dylib 中找到插件入口</li>
<li>调用插件中的注册方法</li>
<li>将方法经过2层包装，放到 <code>op_table</code> 中，以注册时 <code>name</code> 为键名，比如 <code>&quot;webview_free&quot;</code></li>
</ul>
<h2 id="调用">调用</h2>
<p>下面开始看下调用的方式，从 js 的调用开始入手：</p>
<pre><code class="language-js">Deno.openPlugin(pluginPath);
var { asyncOp: asyncOpId, syncOp: syncOpId } = Deno.core.ops();

export function syncOpWrapper(zeroCopy) {
  return Deno.core.dispatch(syncOpId, zeroCopy);
}
</code></pre>
<p><code>openPlugin</code> 的定义在 <a href="https://github.com/denoland/deno/blob/master/cli/rt/40_plugins.js#L6">deno/cli/rt/40_plugins.js#L6</a></p>
<p><code>code.dispatch</code> 的定义在 <a href="https://github.com/denoland/deno/blob/master/core/core.js#L185">deno/core/core.js#L185</a>，其内部又是使用的 <code>send</code>，而 <code>send</code> 和 <code>recv</code> 的定义在 <a href="https://github.com/denoland/deno/blob/master/core/bindings.rs#L139">deno/core/bindings.rs#L139</a></p>
<p><code>send</code> 的实现在 <a href="https://github.com/denoland/deno/blob/master/core/bindings.rs#L385">deno/bindings.rs#L385</a>，其中的关键方法就是：</p>
<pre><code class="language-rust">let op = OpTable::route_op(op_id, state.op_state.clone(), bufs);
</code></pre>
<p>可以看到和注册部分已经串联起来了，简单说就是注册是将方法添加到 hashmap 中，key 是方法名，value 是方法实现，调用的时候，再去 hashmap 里面根据 key 找实现，然后调用</p>
<p>可以看下 <code>OpTable::route_op</code> 的实现 <a href="https://github.com/denoland/deno/blob/master/core/ops.rs#L86">deno/core/ops.rs#L86</a>，其中关键调用是：</p>
<pre><code class="language-rust">match op_fn {
  Some(f) =&gt; (f)(state, bufs), // 这里
  None =&gt; Op::NotFound,
}
</code></pre>
<p>可以看到是直接的函数调用</p>
<p>另外 js -&gt; rust 的调用时，并没有对参数进行序列化操作，而是使用的 <code>ZeroCopyBuf</code>，按照它的注释来看，它并没有做内存拷贝，而是将对应的原本由 v8 的 GC 控制的内存，绑定到 <code>ZeroCopyBuf</code> 实例的生命周期中，最坏情况下（rust 方法内没有显式地提前释放），就是这块内存直到相应的 <code>rust</code> 方法执行完毕后才会被释放</p>
<p>当然也有序列化的版本 <a href="https://github.com/denoland/deno/blob/master/core/ops.rs#L180">json_op_sync</a>，这样参数就会经过 JSON 的序列化和反序列化</p>
<p>上面只分析了同步调用的情况，异步调用的情况目前看来，可以将简单看成是将 js 的主线程和 rust 主线程绑定到了一起，剩下的异步操作，依赖了 rust 的 async 实现自动做调度</p>
<h2 id="访问Isolate信息">访问 Isolate 信息</h2>
<p>最初的学习是希望 native plugin 中可以访问到 <code>v8::Isolate</code> 从而拿到运行时的信息做简单的监控，目前看来插件 API 并没有将这块的访问开放出来，可能需要提个 issue 去问一问</p>
<p>目前看来可以通过自己定义调用签名的方式来完成调用，有待验证其他方法，因为 version 是在 read-only 区的，也就是 <code>&#x27;static</code> lifetime 的，所以成功的结果不太有力：</p>
<pre><code class="language-rust">extern &quot;C&quot; {
    fn v8__V8__GetVersion() -&gt; *const c_char;
}

pub fn gc_stats(_interface: &amp;mut dyn Interface, _zero_copy: &amp;mut [ZeroCopyBuf]) -&gt; Op {
    unsafe {
        let c_str: &amp;CStr =  CStr::from_ptr(v8__V8__GetVersion());
        println!(&quot;{:?}&quot;, c_str.to_str());
    }
    Op::Sync(Box::new([]))
}
</code></pre></div></div></div><div class="_3a4jt6lr4yLRJnQge009wv"><ul><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#demo">demo</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#插件注册">插件注册</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#调用">调用</a></span></div><ul></ul></div></li><li><div class="pr9M2Qxu3rP9KbtpZMUZy"><div class="_3BS2IRzowIlPVoY1ThvbNb"><span><a class="" href="#访问Isolate信息">访问 Isolate 信息</a></span></div><ul></ul></div></li></ul></div><div class="_1UY_ItV2UTWKutKs5b7NKg">Made with <a target="_blank" href="https://github.com/hsiaosiyuan0/gadget">gadget</a></div></div></div><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-core.min.js" data-manual="true"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-markup.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-clike.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-json.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-javascript.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-jsx.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-typescript.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-tsx.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-bash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-python.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-xml-doc.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-docker.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-rust.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-nasm.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-c.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-cpp.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-xml-doc.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/toolbar/prism-toolbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-highlight/prism-line-highlight.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/show-language/prism-show-language.min.js"></script><script src="https://cdn.jsdelivr.net/gh/cferdinandi/gumshoe@5.1.1/dist/gumshoe.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react@16.14.0/umd/react.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react-dom@16.14.0/umd/react-dom.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react@16.14.0/umd/react.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react-dom@16.14.0/umd/react-dom.production.min.js"></script><script>window["__gadget__"]={"initialProps":{"data":{"post":{"filename":"native-plugin","rawMeta":{"title":"deno native plugin 内部实现机制"},"content":"# deno native plugin 内部实现机制\n\n## demo\n\n可以使用 [create-deno-plugin](https://github.com/chiefbiiko/create-deno-plugin) 创建一个插件工程，方便对插件有个具象化的感知\n\n## 插件注册\n\n1. 首先是载入 dynamic library 见 [deno/cli/ops/plugin.rs#L59](https://github.com/denoland/deno/blob/master/cli/ops/plugin.rs#L59)，并找到模块中的符号 `deno_plugin_init`，这是 deno 扩展机制和插件开发者约定的入口\n\n2. 然后调用模块中的 `deno_plugin_init` 方法，来注册模块希望暴露给 js 环境的方法，注册的步骤见 [deno/cli/ops/plugin.rs#L71](https://github.com/denoland/deno/blob/master/cli/ops/plugin.rs#L71)\n\n3. 模块中是以何种形式将自己的方法注册的呢，详见 [webview_deno/src/lib.rs#L31](https://github.com/webview/webview_deno/blob/master/src/lib.rs#L31)，挑部分简单看下：\n\n```rust\n#[no_mangle] // 很重要，否则第2步就找不到符号了，因为 rust 支持重载之类的特性，所以编译后函数名会有变动\npub fn deno_plugin_init(interface: &mut dyn Interface) {\n  interface.register_op(\"webview_free\", webview_free);\n}\n\n#[json_op]\nfn webview_free(\n  json: Value,\n  _zero_copy: &mut [ZeroCopyBuf],\n) -> Result<Value, AnyError> {\n  // ...\n}\n```\n\n可以看到，就是很语义化的一条注册语句 `register_op`\n\n4. 简单看一下 `register_op` 的实现，详见 [deno/cli/ops/plugin.rs#L103](https://github.com/denoland/deno/blob/master/cli/ops/plugin.rs#L103)\n\n```rust\nfn register_op(\n  &mut self,\n  name: &str,\n  dispatch_op_fn: plugin_api::DispatchOpFn,\n) -> OpId {\n  // ...\n  let plugin_op_fn = move |state_rc: Rc<RefCell<OpState>>,\n                            mut zero_copy: BufVec| {\n    // ...\n    let op = dispatch_op_fn(&mut interface, &mut zero_copy);\n    // ...\n  };\n  self\n    .state\n    .op_table\n    .register_op(name, metrics_op(Box::new(plugin_op_fn)))\n}\n```\n\n`dispatch_op_fn` 是插件注册的方法，比如上文的 `webview_free`，然后包装成另一个函数 `plugin_op_fn` 后注册，目前看来包装的目的应该是做一个出入参的调整，包装好后的函数被注册到了 `state.op_table` 中\n\n如果进入 `metrics_op` 的实现查看的话，会发现它又包了一层 [deno/cli/metrics.rs#L82](https://github.com/denoland/deno/blob/master/cli/metrics.rs#L82) 暂时看不知道原因\n\n注册的步骤就到此为止了，流程可以大致梳理为：\n\n- 从 dylib 中找到插件入口\n- 调用插件中的注册方法\n- 将方法经过2层包装，放到 `op_table` 中，以注册时 `name` 为键名，比如 `\"webview_free\"`\n\n## 调用\n\n下面开始看下调用的方式，从 js 的调用开始入手：\n\n```js\nDeno.openPlugin(pluginPath);\nvar { asyncOp: asyncOpId, syncOp: syncOpId } = Deno.core.ops();\n\nexport function syncOpWrapper(zeroCopy) {\n  return Deno.core.dispatch(syncOpId, zeroCopy);\n}\n```\n\n`openPlugin` 的定义在 [deno/cli/rt/40_plugins.js#L6](https://github.com/denoland/deno/blob/master/cli/rt/40_plugins.js#L6)\n\n`code.dispatch` 的定义在 [deno/core/core.js#L185](https://github.com/denoland/deno/blob/master/core/core.js#L185)，其内部又是使用的 `send`，而 `send` 和 `recv` 的定义在 [deno/core/bindings.rs#L139](https://github.com/denoland/deno/blob/master/core/bindings.rs#L139)\n\n`send` 的实现在 [deno/bindings.rs#L385](https://github.com/denoland/deno/blob/master/core/bindings.rs#L385)，其中的关键方法就是：\n\n```rust\nlet op = OpTable::route_op(op_id, state.op_state.clone(), bufs);\n```\n\n可以看到和注册部分已经串联起来了，简单说就是注册是将方法添加到 hashmap 中，key 是方法名，value 是方法实现，调用的时候，再去 hashmap 里面根据 key 找实现，然后调用\n\n可以看下 `OpTable::route_op` 的实现 [deno/core/ops.rs#L86](https://github.com/denoland/deno/blob/master/core/ops.rs#L86)，其中关键调用是：\n\n```rust\nmatch op_fn {\n  Some(f) => (f)(state, bufs), // 这里\n  None => Op::NotFound,\n}\n```\n\n可以看到是直接的函数调用\n\n另外 js -> rust 的调用时，并没有对参数进行序列化操作，而是使用的 `ZeroCopyBuf`，按照它的注释来看，它并没有做内存拷贝，而是将对应的原本由 v8 的 GC 控制的内存，绑定到 `ZeroCopyBuf` 实例的生命周期中，最坏情况下（rust 方法内没有显式地提前释放），就是这块内存直到相应的 `rust` 方法执行完毕后才会被释放\n\n当然也有序列化的版本 [json_op_sync](https://github.com/denoland/deno/blob/master/core/ops.rs#L180)，这样参数就会经过 JSON 的序列化和反序列化\n\n上面只分析了同步调用的情况，异步调用的情况目前看来，可以将简单看成是将 js 的主线程和 rust 主线程绑定到了一起，剩下的异步操作，依赖了 rust 的 async 实现自动做调度\n\n\n## 访问 Isolate 信息\n\n最初的学习是希望 native plugin 中可以访问到 `v8::Isolate` 从而拿到运行时的信息做简单的监控，目前看来插件 API 并没有将这块的访问开放出来，可能需要提个 issue 去问一问\n\n目前看来可以通过自己定义调用签名的方式来完成调用，有待验证其他方法，因为 version 是在 read-only 区的，也就是 `'static` lifetime 的，所以成功的结果不太有力：\n\n```rust\nextern \"C\" {\n    fn v8__V8__GetVersion() -> *const c_char;\n}\n\npub fn gc_stats(_interface: &mut dyn Interface, _zero_copy: &mut [ZeroCopyBuf]) -> Op {\n    unsafe {\n        let c_str: &CStr =  CStr::from_ptr(v8__V8__GetVersion());\n        println!(\"{:?}\", c_str.to_str());\n    }\n    Op::Sync(Box::new([]))\n}\n```\n","slug":"/deno/native-plugin","toc":[{"name":"demo","depth":2,"anchor":"#demo","children":[]},{"name":"插件注册","depth":2,"anchor":"#插件注册","children":[]},{"name":"调用","depth":2,"anchor":"#调用","children":[]},{"name":"访问 Isolate 信息","depth":2,"anchor":"#访问Isolate信息","children":[]}],"keywords":[],"mtime":1615393171068},"catalog":[{"name":"v8","url":"/post/v8","children":[{"name":"debug-v8-in-vscode","url":"/post/v8/debug-v8-in-vscode.html","children":[]},{"name":"v8 常见数据类型","url":"/post/v8/common-data-types.html","children":[]}]},{"name":"deno","url":"/post/deno","children":[{"name":"deno native plugin 内部实现机制","url":"/post/deno/native-plugin.html","children":[]}]},{"name":"crypto","url":"/post/crypto","children":[{"name":"加密算法调研","url":"/post/crypto/brief-crypto.html","children":[]}]},{"name":"nodejs","url":"/post/nodejs","children":[{"name":"Cluster 模块分析","url":"/post/nodejs/Cluster 模块分析.html","children":[]},{"name":"build-from-source","url":"/post/nodejs/build-from-source.html","children":[]},{"name":"node-addon","url":"/post/nodejs/node-addon.html","children":[]},{"name":"common-snippet","url":"/post/nodejs/common-snippet.html","children":[]},{"name":"v8 Heapsnapshot 文件解析","url":"/post/nodejs/heap-snapshot.html","children":[]},{"name":"Libuv 之 - 只看这篇是不够的","url":"/post/nodejs/libuv.html","children":[]},{"name":"Objects in V8","url":"/post/nodejs/object-in-v8.html","children":[]},{"name":"Libuv 之上的 Node","url":"/post/nodejs/node-on-libuv.html","children":[]}]},{"name":"websocket","url":"/post/websocket","children":[{"name":"WebSocket 协议 1~4 节","url":"/post/websocket/WebSocket 协议 1~4 节.html","children":[]},{"name":"WebSocket 协议 5~10 节","url":"/post/websocket/WebSocket 协议 5~10 节.html","children":[]}]},{"name":"assembly","url":"/post/assembly","children":[{"name":"汇编语言学习小结","url":"/post/assembly/汇编语言学习小结.html","children":[]}]},{"name":"typescript","url":"/post/typescript","children":[{"name":"Decorator in babel and tsc","url":"/post/typescript/decorator.html","children":[]}]},{"name":"rust","url":"/post/rust","children":[{"name":"Lifetime","url":"/post/rust/lifetime.html","children":[]}]},{"name":"oop","url":"/post/oop","children":[{"name":"midway 分析","url":"/post/oop/ioc.html","children":[]}]},{"name":"php","url":"/post/php","children":[{"name":"为什么 PHP 不适合长时间运行","url":"/post/php/为什么 PHP 不适合长时间运行.html","children":[]}]},{"name":"blockchain","url":"/post/blockchain","children":[{"name":"crypto-conditions 简述","url":"/post/blockchain/crypto-conditions 简述.html","children":[]},{"name":"实用拜占庭容错简介","url":"/post/blockchain/实用拜占庭容错简介.html","children":[]}]},{"name":"browser","url":"/post/browser","children":[{"name":"浏览器异步加载和同源策略","url":"/post/browser/浏览器异步加载和同源策略.html","children":[]}]},{"name":"cpp","url":"/post/cpp","children":[{"name":"The as-if rule","url":"/post/cpp/the-as-if-rule.html","children":[]}]},{"name":"work","url":"/post/work","children":[{"name":"Parsing in practice","url":"/post/work/parsing-in-practice.html","children":[]}]},{"name":"os","url":"/post/os","children":[{"name":"大小端序","url":"/post/os/大小端序.html","children":[]},{"name":"UTF-8 编码及检查其完整性","url":"/post/os/UTF-8 编码及检查其完整性.html","children":[]},{"name":"魔数 0x7c00","url":"/post/os/魔数0x7c00.html","children":[]},{"name":"字符集和字符编码","url":"/post/os/字符集和字符编码.html","children":[]}]},{"name":"javascript","url":"/post/javascript","children":[{"name":"Generator Function","url":"/post/javascript/generator function.html","children":[]},{"name":"解析 JSON 的成本","url":"/post/javascript/解析 JSON 的成本.html","children":[]},{"name":"Javascript 内部的字符编码","url":"/post/javascript/Javascript 内部的字符编码.html","children":[]},{"name":"闭包的作用","url":"/post/javascript/闭包的作用.html","children":[]},{"name":"闭包是什么","url":"/post/javascript/闭包是什么.html","children":[]}]},{"name":"static-analysis","url":"/post/static-analysis","children":[{"name":"使用 Rust 重写 ternjs","url":"/post/static-analysis/ternjs.html","children":[]}]},{"name":"react","url":"/post/react","children":[{"name":"build-from-source","url":"/post/react/build-from-source.html","children":[]},{"name":"bootstrap","url":"/post/react/bootstrap.html","children":[]}]},{"name":"ripplet","url":"/post/ripplet","children":[{"name":"码个自己的语言","url":"/post/ripplet/create_your_own_lang.html","children":[]}]},{"name":"dev","url":"/post/dev","children":[]},{"name":"esbuild","url":"/post/esbuild","children":[]}],"title":"The hard ways"}},"currentRoute":{"pattern":"/post","href":{"pathname":"/post"}},"pageModules":{"/index":["/pages/index.js"],"/post":["/pages/post.css","/pages/post.js"],"/sitemap":["/pages/sitemap.css","/pages/sitemap.js"],"/post/*":["/pages/post.css","/pages/post.js"]},"router":{"basename":"/","hash":false,"routes":["/index","/post","/sitemap","/post/*"]}};</script><script crossorigin="anonymous" src="/app.js"></script><script crossorigin="anonymous" src="/foundation.js"></script><script crossorigin="anonymous" src="/lib.js"></script><script crossorigin="anonymous" src="/shared-pages_post_tsx.js"></script><script crossorigin="anonymous" src="/pages/post.js"></script></body></html>