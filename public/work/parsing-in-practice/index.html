<!DOCTYPE html>
<html lang="en-us">
  <head>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Parsing in practice | hsiaosiyuan</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="http://example.org/css/theme-override.css">
    <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="http://example.org/">~/hsiaosiyuan</a>
      </li>
      

      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Parsing in practice</span></h1>

<h2 class="date">2019/06/17</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>


<div class="content-wrapper">
  <main>
    <h1 id="parsing-in-practice">Parsing in practice</h1>
<p>现在工作中的项目是一个数据展示类的项目，主要负责将后端分析过的数据，通过 charts 显示到页面中。项目是前后端分离的，它构架是：</p>
<pre><code>前端页面 -&gt; nodejs 中间层 -&gt; java 服务
</code></pre><p>比如现在页面中需要显示三个指标：访客数(UV)，支付订单数(PAY_ORDER_CNT)，退货率</p>
<p>对于前两个指标，要得到它们的数值非常简单，就是把括号中的字母内容作为 key 提交给接口服务，接口服务就会返回 key 所对应的数值，前端得到数据直接显示即可。我们可以暂且把这种可以直接由 key 取到内容的指标成为 &ldquo;简单指标&rdquo;，并且由于接口不支持多个 key 同时查询，所以每个简单指标必须独立为一个接口请求。</p>
<p>对于退货率这个指标，我们可以称之为 &ldquo;复合指标&rdquo;，它是由几个简单指标计算得来的，比如这个退货率，它在后端提供的文档中描述的表达式是:</p>
<pre><code>RETURN_ORDER_CNT / (RETURN_ORDER_CNT + SUB_PAY_ORDER_CNT)
</code></pre><p>这个表达式中涉及的两个简单指标是：退货订单数(RETURN_ORDER_CNT) 和 正向支付订单数(SUB_PAY_ORDER_CNT)。然而，在实际操作中，会有各种简单指标进行运算组合的复合指标，而且由于复合指标的需求是会不断更改和增加的，所以如果只是针对每个复合指标不断写子处理程序的话，那么工作量以及维护成本将会很高。对于复合指标的计算，本应该放在服务端运行，由接口直接提供计算结果，但是由于它们机械繁琐的工作量，后端没人愿意做。</p>
<p>毕竟到了前端就没人可以说理去了，总不能让用户自己来算复合指标吧。这时我们的编译技术排上了用场。</p>
<p>首先复合指标都是一些简单的数学表达式，把这些复合指标的计算表达式形容成 DSL 也不过份吧。</p>
<p>要计算复合指标，只需要分两步：</p>
<ol>
<li>分别请求计算复合指标所需的每个简单指标的值</li>
<li>对表达式进行求值</li>
</ol>
<p>好在这个 DSL 非常的简单，只要处理表达式的解，而且只有双目运算，就省去了结合性的考虑，只要处理运算符优先级就可以了。</p>
<p>因为只是处理运算符的优先级，利用 <a href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">Shunting Yard Algorithm</a> 就好了。将表达式由 中缀(infix) 转换成 后缀(postfix) 形式，保存在一个栈中，</p>
<pre><code>RETURN_ORDER_CNT/(RETURN_ORDER_CNT+SUB_PAY_ORDER_CNT)
</code></pre><p>就被处理成了</p>
<pre><code>// 栈底 -&gt; 栈顶
RETURN_ORDER_CNT RETURN_ORDER_CNT SUB_PAY_ORDER_CNT + /
</code></pre><p>然后逐个弹出栈中的内容，如果是运算符，就分别弹出两个操作数，如果操作数又是运算符，那么就递归调用，如果操作数是标识符，那么就带入之前的简单指标请求的结果，最后根据不同的运算符来对两个操作数进行运算。</p>
<p>这是一个在线的预览 <a href="https://jsfiddle.net/hsiaosiyuan/cr17w07q/5/">复合指标计算</a>，点击了 run 之后，打开 console 看下是否有没有通过的 assert 就可以了。</p>

    <a href="/"> >> Home</a>
  </main>
</div>
    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/hsiaosiyuan0">GitHub</a>
      
    </footer>
  </body>
</html>

